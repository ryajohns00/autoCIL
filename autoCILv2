Option Explicit

' ============================================================
' autoCIL v2 — Direct scan (no sheet import)
' I scan every Excel file in a chosen folder (and subfolders),
' find trace-like sheets, and pull revs into THIS workbook’s CIL.
' ============================================================
Public Sub autoCILv2_BuildCIL_FromTraceFiles()

    On Error GoTo FailHandler

    Dim masterWB As Workbook
    Dim folderPath As String
    Dim fileList As Collection
    Dim filePath As Variant
    Dim wb As Workbook
    Dim ws As Worksheet

    Set masterWB = ThisWorkbook

    Application.ScreenUpdating = False
    Application.DisplayAlerts = False
    Application.EnableEvents = False

    ' I must have a CIL sheet in the master
    If Not autoCILv2_SheetExists(masterWB, "CIL") Then
        MsgBox "ERROR: No CIL sheet in master workbook.", vbCritical
        GoTo CleanExit
    End If

    folderPath = autoCILv2_SelectFolder()
    If folderPath = "" Then GoTo CleanExit

    Set fileList = New Collection
    autoCILv2_GetAllExcelFiles folderPath, fileList

    ' I loop every workbook I found
    For Each filePath In fileList

        Set wb = Workbooks.Open(CStr(filePath), ReadOnly:=True, UpdateLinks:=False)

        ' I only process trace-like sheets
        For Each ws In wb.Worksheets
            If autoCILv2_IsTraceLikeSheet(ws) Then
                autoCILv2_ProcessOneTraceSheet masterWB, ws
            End If
        Next ws

        wb.Close SaveChanges:=False
    Next filePath

    MsgBox "CIL build complete — processed " & fileList.Count & " workbooks.", vbInformation

CleanExit:
    Application.EnableEvents = True
    Application.DisplayAlerts = True
    Application.ScreenUpdating = True
    Exit Sub

FailHandler:
    MsgBox "ERROR: " & Err.Description, vbCritical
    Resume CleanExit

End Sub


' ============================================================
' I process one trace worksheet from an external workbook.
' I match part numbers and write revs into the master CIL.
' ============================================================
Private Sub autoCILv2_ProcessOneTraceSheet(masterWB As Workbook, traceWS As Worksheet)

    Dim pnumber As String, tracePN As String
    Dim rev As String, existingRev As String, newRev As String
    Dim rowNum As Long, traceRow As Long
    Dim cilLastRow As Long, traceLastRow As Long, startRow As Long

    cilLastRow = masterWB.Sheets("CIL").Cells(masterWB.Sheets("CIL").Rows.Count, "A").End(xlUp).Row
    traceLastRow = traceWS.Cells(traceWS.Rows.Count, "B").End(xlUp).Row
    startRow = autoCILv2_GetCILStartRow(masterWB)

    For rowNum = startRow To cilLastRow

        pnumber = masterWB.Sheets("CIL").Range("A" & rowNum).Text

        If autoCILv2_IsPartNumber(pnumber) Then

            traceRow = 5

            Do While traceRow <= traceLastRow

                tracePN = traceWS.Range("B" & traceRow).Text

                If tracePN = pnumber Then

                    rev = traceWS.Range("G" & traceRow).Text

                    ' I skip blanks / junk rev text
                    If Not autoCILv2_IsValidRev(rev) Then
                        traceRow = traceRow + 1
                        GoTo ContinueScan
                    End If

                    ' If CIL E is empty, I write the first rev
                    If Not autoCILv2_IsValidRev(masterWB.Sheets("CIL").Range("E" & rowNum).Text) Then

                        masterWB.Sheets("CIL").Range("E" & rowNum).Value = autoCILv2_CleanRev(rev)
                        autoCILv2_CenterCell masterWB.Sheets("CIL").Range("E" & rowNum)

                    Else
                        ' Otherwise I compare against legacy D and append if needed
                        existingRev = autoCILv2_CleanRev(masterWB.Sheets("CIL").Range("D" & rowNum).Text)

                        If existingRev <> autoCILv2_CleanRev(rev) Then

                            If existingRev = "" Then
                                newRev = autoCILv2_CleanRev(rev)
                            Else
                                newRev = existingRev & "," & autoCILv2_CleanRev(rev)
                            End If

                            masterWB.Sheets("CIL").Range("E" & rowNum).Value = newRev
                            autoCILv2_CenterCell masterWB.Sheets("CIL").Range("E" & rowNum)
                        End If
                    End If

                    Exit Do ' stop after first good match
                End If

                traceRow = traceRow + 1
ContinueScan:
            Loop
        End If
    Next rowNum

End Sub


' ============================================================
' I find where real CIL data starts.
' ============================================================
Private Function autoCILv2_GetCILStartRow(masterWB As Workbook) As Long

    Dim ws As Worksheet, lastRow As Long, r As Long
    Dim cellText As String

    Set ws = masterWB.Sheets("CIL")
    lastRow = ws.Cells(ws.Rows.Count, "A").End(xlUp).Row

    ' pass 1 — search header markers
    For r = 1 To Application.Min(lastRow, 200)
        cellText = UCase(Trim(ws.Range("A" & r).Text))

        If cellText Like "*IDENTIFICATION NUMBER*" _
        Or cellText Like "*PART NUMBER*" _
        Or cellText Like "*ITEM NUMBER*" _
        Or cellText Like "*CONFIGURATION IDENTIFICATION LIST*" Then

            autoCILv2_GetCILStartRow = r + 1
            Exit Function
        End If
    Next r

    ' pass 2 — first row that looks like a PN
    For r = 1 To lastRow
        cellText = Trim(ws.Range("A" & r).Text)
        If autoCILv2_IsPartNumber(cellText) Then
            autoCILv2_GetCILStartRow = r
            Exit Function
        End If
    Next r

    ' fallback
    autoCILv2_GetCILStartRow = 12

End Function


' ============================================================
' I decide if a string is a part number.
' ============================================================
Private Function autoCILv2_IsPartNumber(s As String) As Boolean

    Dim t As String: t = Trim(s)
    If t = "" Then Exit Function

    ' I ignore obvious labels
    If InStr(1, t, "PART NUMBER", vbTextCompare) > 0 Then Exit Function
    If InStr(1, t, "IDENTIFICATION", vbTextCompare) > 0 Then Exit Function
    If InStr(1, t, "CONFIGURATION", vbTextCompare) > 0 Then Exit Function
    If InStr(1, t, "CONTRACT", vbTextCompare) > 0 Then Exit Function
    If InStr(1, t, "PROGRAM", vbTextCompare) > 0 Then Exit Function

    ' must contain digits and be long enough
    If t Like "*[0-9]*" And Len(t) >= 4 Then
        autoCILv2_IsPartNumber = True
    End If

End Function


' ============================================================
' I detect trace-like sheets by checking B and G density.
' ============================================================
Private Function autoCILv2_IsTraceLikeSheet(ws As Worksheet) As Boolean

    Dim bCount As Long, gCount As Long, r As Long

    For r = 5 To 20
        If Trim(ws.Range("B" & r).Text) <> "" Then bCount = bCount + 1
        If Trim(ws.Range("G" & r).Text) <> "" Then gCount = gCount + 1
    Next r

    autoCILv2_IsTraceLikeSheet = (bCount >= 3 And gCount >= 3)

End Function


' ============================================================
' I validate and clean revision strings.
' ============================================================
Private Function autoCILv2_IsValidRev(s As String) As Boolean

    Dim t As String: t = LCase(Trim(s))
    If t = "" Then Exit Function
    If t = "no data available" Then Exit Function
    If t = ",no data available" Then Exit Function

    autoCILv2_IsValidRev = True

End Function

Private Function autoCILv2_CleanRev(s As String) As String

    Dim t As String: t = Trim(s)

    If LCase(t) = "no data available" Then t = ""
    If LCase(t) = ",no data available" Then t = ""

    autoCILv2_CleanRev = t

End Function


' ============================================================
' small helpers
' ============================================================
Private Sub autoCILv2_CenterCell(c As Range)
    c.HorizontalAlignment = xlCenter
    c.VerticalAlignment = xlCenter
End Sub

Private Function autoCILv2_SheetExists(wb As Workbook, sheetName As String) As Boolean
    Dim ws As Worksheet
    On Error Resume Next
    Set ws = wb.Sheets(sheetName)
    autoCILv2_SheetExists = Not ws Is Nothing
    On Error GoTo 0
End Function


' ============================================================
' folder / file scanning
' ============================================================
Private Function autoCILv2_SelectFolder() As String

    Dim dialog As FileDialog
    Set dialog = Application.FileDialog(msoFileDialogFolderPicker)

    dialog.Title = "Select Trace Root Folder"
    dialog.AllowMultiSelect = False

    If dialog.Show <> -1 Then
        autoCILv2_SelectFolder = ""
    Else
        autoCILv2_SelectFolder = dialog.SelectedItems(1)
    End If

End Function

Private Sub autoCILv2_GetAllExcelFiles(folderPath As String, fileList As Collection)

    Dim fso As Object: Set fso = CreateObject("Scripting.FileSystemObject")
    Dim folder As Object: Set folder = fso.GetFolder(folderPath)
    Dim file As Object, subFolder As Object

    For Each file In folder.Files
        Select Case LCase(fso.GetExtensionName(file.Name))
            Case "xlsx", "xlsm", "xls"
                fileList.Add file.Path
        End Select
    Next file

    For Each subFolder In folder.SubFolders
        autoCILv2_GetAllExcelFiles subFolder.Path, fileList
    Next subFolder

End Sub
