Option Explicit

' =========================
' autoCIL v4.6 (final hardening)
'
' What changed from v4.5
' - Restores Excel application state to what the user had before running.
' - Adds per file error context, file path, sheet name, and step, for fast debugging.
' - Skips the master workbook if it lives in the target folder.
' - Tracks duplicate part numbers in the CIL master and reports them.
' - Processes trace sheets using arrays to reduce worksheet calls and speed up runtime.
' - Expands header search bounds and logs when headers are not found.
' - Applies alignment formatting once per range instead of per cell.
'
' This keeps the original v4.5 architecture and behavior.
' =========================

Public Sub Run_autoCILv4_6()

    Dim masterWB As Workbook
    Dim masterWS As Worksheet
    Dim folderPath As String
    Dim fileName As String
    Dim traceWB As Workbook
    Dim traceWS As Worksheet
    
    Dim dict As Object               ' PartNumber to Revision lookup
    Dim dupes As Object              ' PartNumbers with duplicates in CIL master
    Dim dupCount As Long
    
    Dim prevScreenUpdating As Boolean
    Dim prevDisplayAlerts As Boolean
    Dim prevEnableEvents As Boolean
    Dim prevCalc As XlCalculation
    
    Dim processedFiles As Long
    Dim skippedFiles As Long
    Dim errFiles As Long
    Dim noHeaderFiles As Long
    
    On Error GoTo FatalErr
    
    ' Capture current Excel state. This macro should not permanently change user settings.
    prevScreenUpdating = Application.ScreenUpdating
    prevDisplayAlerts = Application.DisplayAlerts
    prevEnableEvents = Application.EnableEvents
    prevCalc = Application.Calculation
    
    ' Turn off expensive Excel features for runtime performance.
    Application.ScreenUpdating = False
    Application.DisplayAlerts = False
    Application.EnableEvents = False
    Application.Calculation = xlCalculationManual
    
    Set masterWB = ThisWorkbook
    
    ' Verify required master sheet exists.
    Set masterWS = Nothing
    On Error Resume Next
    Set masterWS = masterWB.Worksheets("CIL")
    On Error GoTo FatalErr
    
    If masterWS Is Nothing Then
        MsgBox "Required sheet 'CIL' not found in master workbook. Aborting.", vbCritical
        GoTo CleanExit
    End If
    
    ' Folder picker should work on both Mac and Windows.
    folderPath = PickFolderCrossPlatform()
    If folderPath = "" Then
        MsgBox "No folder selected. Aborting.", vbExclamation
        GoTo CleanExit
    End If
    
    ' Build reference dictionary from the master CIL sheet.
    Set dict = CreateObject("Scripting.Dictionary")
    Set dupes = CreateObject("Scripting.Dictionary")
    
    BuildCILDictionary masterWS, dict, dupes, dupCount
    
    If dict.Count = 0 Then
        MsgBox "No valid Part Numbers found on CIL sheet. Aborting.", vbCritical
        GoTo CleanExit
    End If
    
    ' Normalize folder path.
    If Right(folderPath, 1) <> Application.PathSeparator Then
        folderPath = folderPath & Application.PathSeparator
    End If
    
    ' Iterate through all Excel files in the selected folder.
    fileName = Dir(folderPath & "*.xls*")
    
    Do While fileName <> ""
        
        On Error GoTo FileErr
        
        ' Skip the master workbook if it is stored in the same folder.
        If LCase(folderPath & fileName) = LCase(masterWB.FullName) Then
            skippedFiles = skippedFiles + 1
            GoTo NextFile
        End If
        
        Set traceWB = Workbooks.Open(folderPath & fileName, ReadOnly:=True)
        
        ' v4.5 behavior assumed the trace sheet is the first worksheet.
        Set traceWS = Nothing
        On Error Resume Next
        Set traceWS = traceWB.Worksheets(1)
        On Error GoTo FileErr
        
        If traceWS Is Nothing Then
            skippedFiles = skippedFiles + 1
            GoTo CloseTrace
        End If
        
        ' Find Part Number and Revision columns by header text.
        Dim colPN As Long, colRev As Long
        Dim headerFound As Boolean
        
        headerFound = FindTraceColumnsByHeader(traceWS, colPN, colRev)
        
        If Not headerFound Then
            noHeaderFiles = noHeaderFiles + 1
            skippedFiles = skippedFiles + 1
            GoTo CloseTrace
        End If
        
        ' Process the trace sheet using arrays to avoid cell by cell calls.
        Run_Check_TraceSheet_Array traceWS, dict, colPN, colRev
        
        processedFiles = processedFiles + 1
        
CloseTrace:
        traceWB.Close SaveChanges:=False
        
NextFile:
        On Error GoTo 0
        fileName = Dir()
        GoTo ContinueLoop
        
FileErr:
        errFiles = errFiles + 1
        
        Debug.Print "autoCIL v4.6 error"
        Debug.Print " file: " & folderPath & fileName
        Debug.Print " sheet: " & IIf(traceWS Is Nothing, "(none)", traceWS.Name)
        Debug.Print " err: " & Err.Number & " - " & Err.Description
        
        On Error Resume Next
        If Not traceWB Is Nothing Then traceWB.Close SaveChanges:=False
        On Error GoTo 0
        
        fileName = Dir()
        
ContinueLoop:
        Set traceWB = Nothing
        Set traceWS = Nothing
    Loop
    
    ' Report duplicate part numbers from the master CIL.
    If dupCount > 0 Then
        MsgBox dupCount & " duplicate Part Numbers found in CIL master." & vbCrLf & _
               "First occurrence used. See Immediate Window for list.", vbExclamation
        DumpDuplicates dupes
    End If
    
    ' Summary message.
    Dim summary As String
    summary = "autoCIL v4.6 complete." & vbCrLf & vbCrLf & _
              "Processed files: " & processedFiles & vbCrLf & _
              "Skipped files: " & skippedFiles & vbCrLf & _
              "Files with header not found: " & noHeaderFiles & vbCrLf & _
              "Files with errors: " & errFiles
    
    MsgBox summary, vbInformation
    
CleanExit:
    ' Restore Excel state to what the user had before running.
    Application.ScreenUpdating = prevScreenUpdating
    Application.DisplayAlerts = prevDisplayAlerts
    Application.EnableEvents = prevEnableEvents
    Application.Calculation = prevCalc
    Exit Sub
    
FatalErr:
    MsgBox "Fatal error in autoCIL v4.6: " & Err.Number & " - " & Err.Description, vbCritical
    Resume CleanExit

End Sub


' =========================
' Dictionary build from master CIL sheet
'
' Assumptions carried from v4.5
' - Part Number is in column A
' - Revision is in column B
' If this changes in the master format, update the column references here.
' =========================
Private Sub BuildCILDictionary(ByVal ws As Worksheet, _
                               ByRef dict As Object, _
                               ByRef dupes As Object, _
                               ByRef dupCount As Long)
    Dim lastRow As Long
    Dim r As Long
    Dim pn As String, rev As String
    
    lastRow = ws.Cells(ws.Rows.Count, "A").End(xlUp).Row
    
    For r = 2 To lastRow
        pn = Trim(CStr(ws.Cells(r, "A").Value))
        rev = Trim(CStr(ws.Cells(r, "B").Value))
        
        If IsPartNumber(pn) Then
            If dict.Exists(pn) Then
                dupCount = dupCount + 1
                If Not dupes.Exists(pn) Then
                    dupes.Add pn, 1
                Else
                    dupes(pn) = dupes(pn) + 1
                End If
            Else
                dict.Add pn, rev
            End If
        End If
    Next r
    
End Sub

Private Sub DumpDuplicates(ByVal dupes As Object)
    Dim k As Variant
    Debug.Print "Duplicate Part Numbers in CIL master:"
    For Each k In dupes.Keys
        Debug.Print "  " & k & " (" & dupes(k) + 1 & " occurrences)"
    Next k
End Sub


' =========================
' Trace header detection
'
' Expanded bounds for resiliency.
' If no headers are found, the file is skipped and logged to Immediate Window.
' =========================
Private Function FindTraceColumnsByHeader(ByVal ws As Worksheet, _
                                          ByRef colPN As Long, _
                                          ByRef colRev As Long) As Boolean
    Dim maxHeaderRows As Long, maxHeaderCols As Long
    Dim r As Long, c As Long
    Dim v As String
    
    maxHeaderRows = 30
    maxHeaderCols = 120
    
    colPN = 0
    colRev = 0
    
    For r = 1 To maxHeaderRows
        For c = 1 To maxHeaderCols
            v = LCase$(Trim$(CStr(ws.Cells(r, c).Value)))
            
            If colPN = 0 Then
                If v Like "*part*" And v Like "*number*" Then colPN = c
                If v = "pn" Or v = "part no" Or v = "part number" Then colPN = c
            End If
            
            If colRev = 0 Then
                If v Like "*rev*" Or v Like "*revision*" Then colRev = c
                If v = "rev" Or v = "revision" Then colRev = c
            End If
            
            If colPN > 0 And colRev > 0 Then
                FindTraceColumnsByHeader = True
                Exit Function
            End If
        Next c
    Next r
    
    Debug.Print "Header not found in trace sheet."
    Debug.Print " file: " & ws.Parent.FullName
    Debug.Print " sheet: " & ws.Name
    
    FindTraceColumnsByHeader = False
End Function


' =========================
' Trace processing using arrays
'
' Loads Part Number and Revision columns into memory, updates in memory,
' then writes back in one shot for speed on large sheets.
' =========================
Private Sub Run_Check_TraceSheet_Array(ByVal ws As Worksheet, _
                                       ByVal dict As Object, _
                                       ByVal colPN As Long, _
                                       ByVal colRev As Long)
    Dim lastRow As Long
    Dim rngPN As Range, rngRev As Range
    Dim arrPN As Variant, arrRev As Variant
    Dim i As Long
    Dim pn As String
    
    lastRow = ws.Cells(ws.Rows.Count, colPN).End(xlUp).Row
    If lastRow < 2 Then Exit Sub
    
    Set rngPN = ws.Range(ws.Cells(2, colPN), ws.Cells(lastRow, colPN))
    Set rngRev = ws.Range(ws.Cells(2, colRev), ws.Cells(lastRow, colRev))
    
    arrPN = rngPN.Value2
    arrRev = rngRev.Value2
    
    For i = 1 To UBound(arrPN, 1)
        pn = Trim$(CStr(arrPN(i, 1)))
        If IsPartNumber(pn) Then
            If dict.Exists(pn) Then
                arrRev(i, 1) = dict(pn)
            End If
        End If
    Next i
    
    rngRev.Value2 = arrRev
    
    ' Apply alignment once to keep formatting consistent.
    rngRev.HorizontalAlignment = xlCenter
End Sub


' =========================
' Part number heuristic
'
' v4.5 rule kept.
' Adjust minimum length if trace data indicates real PNs shorter than 4 chars.
' =========================
Private Function IsPartNumber(ByVal s As String) As Boolean
    s = Trim$(s)
    
    If Len(s) < 4 Then
        IsPartNumber = False
        Exit Function
    End If
    
    Dim i As Long, ch As String
    For i = 1 To Len(s)
        ch = Mid$(s, i, 1)
        If Not (ch Like "[A-Za-z0-9-_/]") Then
            IsPartNumber = False
            Exit Function
        End If
    Next i
    
    IsPartNumber = True
End Function


' =========================
' Cross platform folder picker
'
' Mac uses AppleScript.
' Windows uses FileDialog.
' Returns empty string if user cancels.
' =========================
Private Function PickFolderCrossPlatform() As String
    Dim path As String
    
#If Mac Then
    On Error Resume Next
    path = MacScript("return POSIX path of (choose folder with prompt ""Select trace sheet folder"")")
    On Error GoTo 0
#Else
    Dim fd As FileDialog
    Set fd = Application.FileDialog(msoFileDialogFolderPicker)
    fd.Title = "Select trace sheet folder"
    If fd.Show = -1 Then
        path = fd.SelectedItems(1)
    Else
        path = ""
    End If
#End If
    
    PickFolderCrossPlatform = path
End Function
